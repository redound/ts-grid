var TSGrid;!function(a){!function(a){a[a.NONE=0]="NONE",a[a.ARROW_UP=1]="ARROW_UP",a[a.ARROW_DOWN=2]="ARROW_DOWN",a[a.ARROW_LEFT=3]="ARROW_LEFT",a[a.ARROW_RIGHT=4]="ARROW_RIGHT",a[a.TAB=5]="TAB",a[a.SHIFT_TAB=6]="SHIFT_TAB",a[a.ENTER=7]="ENTER",a[a.BACKSPACE=8]="BACKSPACE",a[a.SAVE=9]="SAVE",a[a.CANCEL=10]="CANCEL"}(a.CommandTypes||(a.CommandTypes={}));a.CommandTypes}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(){function b(){}return b.prototype.setType=function(a){this.commandType=a},b.prototype.setEvent=function(b){switch(this.event=b,this.type=b.type,this.ctrlKey=!!b.ctrlKey,this.keyCode=b.keyCode,this.shiftKey=!!b.shiftKey,!0){case 38===this.keyCode:this.commandType=a.CommandTypes.ARROW_UP;break;case 40===this.keyCode:this.commandType=a.CommandTypes.ARROW_DOWN;break;case this.shiftKey&&9===this.keyCode:this.commandType=a.CommandTypes.SHIFT_TAB;break;case 37===this.keyCode:this.commandType=a.CommandTypes.ARROW_LEFT;break;case!this.shiftKey&&9===this.keyCode:this.commandType=a.CommandTypes.TAB;break;case 39===this.keyCode:this.commandType=a.CommandTypes.ARROW_RIGHT;break;case!this.shiftKey&&13===this.keyCode:this.commandType=a.CommandTypes.ENTER;break;case 8===this.keyCode:this.commandType=a.CommandTypes.BACKSPACE;break;case 27===this.keyCode:this.commandType=a.CommandTypes.CANCEL;break;default:this.commandType=a.CommandTypes.NONE}},b.prototype.getEvent=function(){return this.event},b.prototype.blurred=function(){return"blur"===this.type},b.prototype.submitted=function(){return"submit"===this.type},b.prototype.clicked=function(){return"click"===this.type},b.prototype.arrowUp=function(){return this.commandType===a.CommandTypes.ARROW_UP},b.prototype.arrowDown=function(){return this.commandType===a.CommandTypes.ARROW_DOWN},b.prototype.arrowLeft=function(){return this.commandType===a.CommandTypes.ARROW_LEFT},b.prototype.arrowRight=function(){return this.commandType===a.CommandTypes.ARROW_RIGHT},b.prototype.shiftTab=function(){return this.commandType===a.CommandTypes.SHIFT_TAB},b.prototype.tab=function(){return this.commandType===a.CommandTypes.TAB},b.prototype.moveUp=function(){return this.arrowUp()},b.prototype.moveDown=function(){return this.arrowDown()},b.prototype.moveLeft=function(){return this.arrowLeft()||this.shiftTab()},b.prototype.moveRight=function(){return this.arrowRight()||this.tab()},b.prototype.enter=function(){return this.commandType===a.CommandTypes.ENTER},b.prototype.backspace=function(){return this.commandType===a.CommandTypes.BACKSPACE},b.prototype.cancel=function(){return this.commandType===a.CommandTypes.CANCEL},b.prototype.navigate=function(){return this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()},b.prototype.navigateWhileEdit=function(){return this.navigate()&&!this.arrowLeft()&&!this.arrowRight()},b.prototype.input=function(){return-1!==b.ALLOWED_INPUT.indexOf(this.keyCode)},b.prototype.passThru=function(){return!(this.navigate()||this.enter()||this.cancel())},b.fromEvent=function(a){var c=new b;return c.setEvent(a),c},b.fromType=function(a){var c=new b;return c.setType(a),c},b.fromAction=function(c){var d=new b;switch(c){case a.CellEditorAction.BLUR:d.setType(a.CommandTypes.CANCEL);break;case a.CellEditorAction.ESC:d.setType(a.CommandTypes.CANCEL);break;case a.CellEditorAction.ENTER:d.setType(a.CommandTypes.ENTER)}return d},b.ALLOWED_INPUT=[100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,167,177,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,91,92,93,94,95,96,97,98,99,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90],b}();a.Command=b}(TSGrid||(TSGrid={}));var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},TSGrid;!function(a){var b=function(b){function c(c,d,e){b.call(this),this.tagName="div",this.className="ts-grid-body",this.rowType=a.Row,this.columns=c,this.collection=d,this.rowType=e,this.initialize()}return __extends(c,b),c.prototype.initialize=function(){var a=this;b.prototype.initialize.call(this),this.rows=new TSCore.Data.SortedList([],function(){}),this.collection.each(function(b){a.rows.add(new a.rowType(a.columns,b))}),this.collection.events.on(TSCore.Data.CollectionEvents.ADD,function(b){return a.insertRows(b)}),this.collection.events.on(TSCore.Data.CollectionEvents.REMOVE,function(b){return a.removeRows(b)})},c.prototype.setGrid=function(b){this._grid=b,b.events.on(a.TSGridEvents.EDITED,this.moveToNextCell,this),b.events.on(a.TSGridEvents.NAVIGATE,this.moveToNextCell,this)},c.prototype.getGrid=function(){return this._grid},c.prototype.insertRow=function(a,b,c){if(_.isUndefined(c))return void this.collection.add(a);var d=new this.rowType(this.columns,a);this.rows.add(d),b=this.rows.indexOf(d);var e=this.$el.find("tbody"),f=e.children(),g=d.render().$el;b>=f.length?e.append(g):f.eq(b).before(g)},c.prototype.insertRows=function(a){var b=this,c=a.params.operations;console.log("insertRows",c),_.each(c,function(a){b.insertRow(a.item,a.index,b.collection)})},c.prototype.removeRows=function(a){var b=this,c=a.params.operations;console.log("removeRows",c);var d=_.map(c,function(a){return b.rows.get(a.index)});_.each(d,function(a){a.remove(),b.rows.remove(a)})},c.prototype.removeRow=function(a){return this.collection.remove(a),this},c.prototype.render=function(){var a=this.getGrid();this.$el.empty();var b=$("<table />"),c=$("<tbody />");return b.append(c),this.rows.each(function(a){c.append(a.render().$el)}),b.attr("width",a.getInnerWidth()),this.$el.append(b),this.delegateEvents(),this},c.prototype.remove=function(){return this.rows.each(function(a){a.remove.apply(a,arguments)}),b.prototype.remove.call(this)},c.prototype.moveToNextCell=function(b){var c,d,e,f,g,h=this.getGrid(),i=b.params.model,j=b.params.column,k=b.params.command,l=this.rows.whereFirst({modelId:i.id}),m=this.rows.indexOf(l),n=this.columns.indexOf(j);if(-1===n)return this;var o=this.rows.get(m).cells.get(n);if(k.navigate()||k.blurred()){var p=this.columns.length,q=p*this.collection.length;if(k.blurred())o.deactivate();else if(k.moveUp()||k.moveDown()){f=m+(k.moveUp()?-1:1);var r=k.getEvent();r&&r.preventDefault();var l=this.rows.get(f);if(l){if(c=l.cells.get(n),a.callByNeed(c.column.getEditable(),c.column,i)){var s=o.editModeActive;o.deactivate(),c.activate(),s&&c.enterEditMode(),h.events.trigger(a.TSGridEvents.NEXT,{row:f,column:n,outside:!1})}}else h.events.trigger(a.TSGridEvents.NEXT,{row:f,column:n,outside:!0})}else if(k.moveLeft()||k.moveRight()){var r=k.getEvent();r&&r.preventDefault();for(var t=k.moveRight(),u=m*p+n+(t?1:-1);u>=0&&q>u;t?u++:u--)if(f=~~(u/p),g=u-f*p,c=this.rows.get(f).cells.get(g),d=a.callByNeed(c.column.getRenderable(),c.column,c.model),e=a.callByNeed(c.column.getEditable(),c.column,i),d&&e){var s=o.editModeActive;o.deactivate(),c.activate(),s&&c.enterEditMode(),h.events.trigger(a.TSGridEvents.NEXT,{row:f,column:g,outside:!1});break}u==q&&h.events.trigger(a.TSGridEvents.NEXT,{row:~~(u/p),column:u-f*p,outside:!0})}}return this},c}(TSCore.App.UI.View);a.Body=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(b){function c(a,c){b.call(this),this.tagName="td",this.editModeActive=!1,this.viewEvents={click:"click",focusout:"focusout",focus:"focus",blur:"blur",keypress:"keypress",keydown:"keydown"},this.column=a,this.model=c,this.initialize()}return __extends(c,b),c.prototype.initialize=function(){b.prototype.initialize.call(this),this.model.events.on(a.TSGridEvents.EDITED,this.doneEditing,this),a.callByNeed(this.column.getEditable(),this.column,this.model)&&this.$el.addClass("editable"),a.callByNeed(this.column.getRenderable(),this.column,this.model)&&this.$el.addClass("renderable")},c.prototype.render=function(){this.$el.empty();var a=this.column.getFormatter(),b=this.column.getGetter(),c=b?b(this.model):this.model.get(this.column.getName()),d=a?a(this.model):c;this.$el.html(d),this.$el.attr("width",this.column.getWidth()),this.$el.css("max-width",this.column.getWidth());var e=this.column.getClassName();return e&&this.$el.addClass(e),this.delegateEvents(),this},c.prototype.keypress=function(b){var c=a.Command.fromEvent(b);if(this.column.getEditOnInput()&&c.input()){var d=String.fromCharCode(b.keyCode);this.enterEditMode(d)}},c.prototype.keydown=function(b){var c=a.Command.fromEvent(b);if(c.enter()&&this.enterEditMode(),c.backspace()&&(b.preventDefault(),this.column.getAllowNull()&&this.clear()),c.navigate()){var d=this.column.getGrid();d.events.trigger(a.TSGridEvents.NAVIGATE,{column:this.column,model:this.model,command:c})}},c.prototype.click=function(){this.$el.is(":focus")?this.enterEditMode():this.activate()},c.prototype.blur=function(){this.$el.removeClass("active"),this.$el.removeAttr("tabindex")},c.prototype.focusout=function(){this.editModeActive&&this.exitEditMode()},c.prototype.activate=function(){this.$el.attr("tabindex",0),this.$el.focus()},c.prototype.focus=function(){this.$el.addClass("active")},c.prototype.deactivate=function(){this.$el.blur()},c.prototype.clear=function(){var a=this.column.getSetter();a?a(this.model):this.model.set(this.column.getName(),null),this.render()},c.prototype.doneEditing=function(a){var b=a.params.column,c=a.params.command;!(c.enter()||c.submitted()||c.cancel())||null!=b&&b.getId()!=this.column.getId()||(this.editModeActive&&this.exitEditMode(),this.activate())},c.prototype.enterEditMode=function(b){var c=this;if(!this.editModeActive){var d=a.callByNeed(this.column.getEditable(),this.column,this.model);if(d){var e=this.column.getEditor();this.currentEditor=e(this.column,this.model),this.model.events.trigger(a.TSGridEvents.EDIT,{model:this.model,column:this.column,cell:this,editor:this.currentEditor}),this.undelegateEvents(),b&&this.currentEditor.setInitialModelValue(b),this.currentEditor.render(),setTimeout(function(){c.blur(),c.$el.empty(),c.$el.append(c.currentEditor.$el),c.$el.addClass("editor"),c.$el.addClass(c.currentEditor.getEditorName())},10),this.editModeActive=!0,this.model.events.trigger(a.TSGridEvents.EDITING,{model:this.model,column:this.column,cell:this,editor:this.currentEditor})}}},c.prototype.renderError=function(a,b){(null==b||b.getName()==this.column.getName())&&this.$el.addClass("error")},c.prototype.exitEditMode=function(){this.editModeActive=!1,this.$el.removeClass("error"),this.$el.removeClass(this.currentEditor.getEditorName()),this.currentEditor.remove(),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},c.prototype.remove=function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),this},c}(TSCore.App.UI.View);a.Cell=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){!function(a){a[a.ESC=0]="ESC",a[a.BLUR=1]="BLUR",a[a.ENTER=2]="ENTER"}(a.CellEditorAction||(a.CellEditorAction={}));var b=(a.CellEditorAction,function(b){function c(a,c,d){b.call(this),this.setColumn(a),this.setModel(c),this.setEditorName(d),this.initialize()}return __extends(c,b),c.prototype.setColumn=function(a){return this.column=a,this},c.prototype.getColumn=function(){return this.column},c.prototype.setModel=function(a){return this.model=a,this},c.prototype.getModel=function(){return this.model},c.prototype.setEditorName=function(a){return this.editorName=a,this},c.prototype.getEditorName=function(){return this.editorName},c.prototype.setInitialModelValue=function(a){return this.initialModelValue=a,this},c.prototype.getInitialModelValue=function(){return this.initialModelValue},c.prototype.setModelValue=function(a){var b=this.column.getSetter();return b?b(this.model,a):this.model.set(this.column.getName(),a),this},c.prototype.getModelValue=function(){var a=this.column.getGetter();return a?a(this.model):this.model.get(this.column.getName())},c.prototype.save=function(b,c){var d=this.model,e=this.column,f=e.getGrid();this.setModelValue(c);var g={model:d,column:e,command:a.Command.fromAction(b)};f.events.trigger(a.TSGridEvents.EDITED,g),d.events.trigger(a.TSGridEvents.EDITED,g)},c.prototype.cancel=function(b){var c=this.model,d=this.column,e=d.getGrid(),f={model:c,column:d,command:a.Command.fromAction(b)};e.events.trigger(a.TSGridEvents.EDITED,f),c.events.trigger(a.TSGridEvents.EDITED,f)},c}(TSCore.App.UI.View));a.CellEditor=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(){function b(){this._renderable=!0,this._editOnInput=!1,this._editable=!1,this._allowNull=!1,this._cellType=a.Cell,this._uniqId=parseInt(_.uniqueId())}return b.prototype.className=function(a){return this._className=a,this},b.prototype.getClassName=function(){return this._className},b.prototype.getId=function(){return this._uniqId},b.prototype.setGrid=function(a){this._grid=a},b.prototype.getGrid=function(){return this._grid},b.prototype.width=function(a){return this._width=a,this},b.prototype.getWidth=function(){return this._width},b.prototype.name=function(a){return this._name=a,this},b.prototype.getName=function(){return this._name},b.prototype.label=function(a){return this._label=a,this},b.prototype.getLabel=function(){return this._label},b.prototype.renderable=function(a){return this._renderable=a,this},b.prototype.getRenderable=function(){return this._renderable},b.prototype.editable=function(a){return this._editable=a,this},b.prototype.getEditable=function(){return this._editable},b.prototype.editOnInput=function(a){return void 0===a&&(a=!0),this._editOnInput=a,this},b.prototype.getEditOnInput=function(){return this._editOnInput},b.prototype.getHeaderType=function(){return a.resolveNameToClass("header-cell")},b.prototype.editor=function(a){return this._editor=a,this},b.prototype.getEditor=function(){return this._editor},b.prototype.allowNull=function(a){return void 0===a&&(a=!0),this._allowNull=a,this},b.prototype.getAllowNull=function(){return this._allowNull},b.prototype.cellType=function(a){return this._cellType=a,this},b.prototype.getCellType=function(){return this._cellType},b.prototype.setter=function(a){return this._setter=a,this},b.prototype.getSetter=function(){return this._setter},b.prototype.getter=function(a){return this._getter=a,this},b.prototype.getGetter=function(){return this._getter},b.prototype.parser=function(a){return this._parser=a,this},b.prototype.getParser=function(){return this._parser},b.prototype.formatter=function(a){return this._formatter=a,this},b.prototype.getFormatter=function(){return this._formatter},b}();a.Column=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(b){function c(a,c,d){b.call(this),this.tagName="div",this.className="ts-grid",this.events=new TSCore.Events.EventEmitter,this.setHeader(a),this.setBody(c),this.setColumns(d),this.initialize()}return __extends(c,b),c.prototype.initialize=function(){b.prototype.initialize.call(this)},c.prototype.setHeader=function(a){return a.setGrid(this),this._header=a,this},c.prototype.getHeader=function(){return this._header},c.prototype.setBody=function(a){return a.setGrid(this),this._body=a,this},c.prototype.getBody=function(){return this._body},c.prototype.setColumns=function(a){var b=this,c=0;return a.each(function(a){a.setGrid(b),c+=a.getWidth()}),this._width=c,this._columns=a,this},c.prototype.getColumns=function(){return this._columns},c.prototype.getInnerWidth=function(){return this._width},c.prototype.getWidth=function(){return this._width+2},c.prototype.insertRow=function(){return this._body.insertRow.apply(this._body,arguments),this},c.prototype.removeRow=function(){return this._body.removeRow.apply(this._body,arguments),this},c.prototype.render=function(){return this.$el.empty(),this._header&&this.$el.append(this._header.render().$el),this.$el.append(this._body.render().$el),this.delegateEvents(),this.events.trigger(a.TSGridEvents.RENDERED),this},c.prototype.remove=function(){return this._header&&this._header.remove.apply(this._header,arguments),this._body.remove.apply(this._body,arguments),b.prototype.remove.call(this)},c}(TSCore.App.UI.View);a.Grid=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(b){function c(a){b.call(this),this.tagName="div",this.className="ts-grid-header",this.columns=a,this.initialize()}return __extends(c,b),c.prototype.initialize=function(){b.prototype.initialize.call(this),this.row=new a.HeaderRow(this.columns,null)},c.prototype.setGrid=function(a){return this._grid=a,this},c.prototype.getGrid=function(){return this._grid},c.prototype.render=function(){var a=this.getGrid(),b=$("<table />"),c=$("<thead />");return b.append(c),c.append(this.row.render().$el),b.attr("width",a.getInnerWidth()),this.$el.append(b),this.delegateEvents(),this},c}(TSCore.App.UI.View);a.Header=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(a){function b(b){a.call(this),this.tagName="th",this.viewEvents={"click a":"click"},this.column=b,this.initialize()}return __extends(b,a),b.prototype.initialize=function(){a.prototype.initialize.call(this)},b.prototype.click=function(){},b.prototype.render=function(){this.$el.empty();var a=document.createTextNode(this.column.getLabel());return this.$el.append(a),this.$el.addClass(this.column.getClassName()),this.$el.attr("width",this.column.getWidth()),this.delegateEvents(),this},b}(TSCore.App.UI.View);a.HeaderCell=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(a){function b(b,c){a.call(this),this.tagName="tr",this.columns=b,this.setModel(c),this.cells=new TSCore.Data.List,this.initialize()}return __extends(b,a),b.prototype.initialize=function(){var b=this;a.prototype.initialize.call(this),this.columns.each(function(a){b.cells.add(b.makeCell(a))})},b.prototype.setModel=function(a){return a?(this.model=a,this.modelId=a.getId(),this):void 0},b.prototype.makeCell=function(a){var b=a.getCellType();return new b(a,this.model)},b.prototype.render=function(){this.$el.empty();var a=document.createDocumentFragment();return this.cells.each(function(b){a.appendChild(b.render().el)}),this.el.appendChild(a),this.delegateEvents(),this},b.prototype.reset=function(){},b}(TSCore.App.UI.View);a.Row=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.makeCell=function(a){var b=a.getHeaderType();return new b(a,this.model)},b}(a.Row);a.HeaderRow=b}(TSGrid||(TSGrid={}));var TSGrid;!function(a){function b(b,c){if(void 0===c&&(c=""),_.isString(b)){var d=_.map(b.split("-"),function(a){return a.slice(0,1).toUpperCase()+a.slice(1)}).join("")+c,e=a[d]||a.Extension[d];if(_.isUndefined(e))throw new ReferenceError("Class '"+d+"' not found");return e}return b}function c(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];var c=arguments[0];if(!_.isFunction(c))return c;var d=arguments[1],e=[].slice.call(arguments,2);return c.apply(d,e+""?e:[])}a.Extension={},a.resolveNameToClass=b,a.callByNeed=c;var d;!function(a){a.RENDERED="tsGrid:rendered",a.SORT="tsGrid:sort",a.EDIT="tsGrid:edit",a.EDITING="tsGrid:editing",a.EDITED="tsGrid:edited",a.ERROR="tsGrid:error",a.NEXT="tsGrid:next",a.NAVIGATE="tsGrid:navigate"}(d=a.TSGridEvents||(a.TSGridEvents={}))}(TSGrid||(TSGrid={}));